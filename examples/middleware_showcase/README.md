# Tang ä¸­é—´ä»¶åŠŸèƒ½å±•ç¤º

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Tang Web æ¡†æ¶ä¸­é—´ä»¶ä½¿ç”¨ç¤ºä¾‹ï¼Œå±•ç¤ºäº†æ‰€æœ‰å¯ç”¨ä¸­é—´ä»¶çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ¯ åŠŸèƒ½å±•ç¤º

æœ¬é¡¹ç›®æ¼”ç¤ºäº†ä»¥ä¸‹ä¸­é—´ä»¶çš„ä½¿ç”¨ï¼š

| ä¸­é—´ä»¶ | åŠŸèƒ½ | é…ç½® |
|--------|------|------|
| **Recovery** | å¼‚å¸¸æ•è·å’Œæ¢å¤ | é»˜è®¤é…ç½® |
| **Access Log** | è®¿é—®æ—¥å¿—è®°å½• | è®°å½•å®¢æˆ·ç«¯ IP |
| **Request ID** | è¯·æ±‚è¿½è¸ª ID | é»˜è®¤é…ç½® |
| **CORS** | è·¨åŸŸèµ„æºå…±äº« | å…è®¸æ‰€æœ‰æ¥æº + æºå¸¦å‡­è¯ |
| **Security** | å®‰å…¨å“åº”å¤´ | ä¸¥æ ¼å®‰å…¨ç­–ç•¥ |
| **Compression** | Gzip å‹ç¼© | é»˜è®¤é…ç½® |
| **Log** | è°ƒè¯•æ—¥å¿— | é»˜è®¤é…ç½® |
| **Basic Auth** | åŸºæœ¬è®¤è¯ | ä¿æŠ¤ `/api/*` è·¯ç”± |
| **Static Files** | é™æ€æ–‡ä»¶æœåŠ¡ | æœåŠ¡ `public/` ç›®å½• |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨æµ‹è¯•ï¼ˆæ¨èï¼‰

**ä¸€é”®å¯åŠ¨å¹¶æµ‹è¯•æ‰€æœ‰ä¸­é—´ä»¶åŠŸèƒ½ï¼š**

```bash
cd examples/middleware_showcase
./test.sh
```

æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. æ„å»ºé¡¹ç›®
2. å¯åŠ¨æœåŠ¡å™¨
3. æµ‹è¯•æ‰€æœ‰ä¸­é—´ä»¶åŠŸèƒ½
4. æ˜¾ç¤ºæµ‹è¯•ç»“æœå’Œæ—¥å¿—
5. è‡ªåŠ¨å…³é—­æœåŠ¡å™¨

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨è¿è¡Œ

#### 1. æ„å»ºé¡¹ç›®

```bash
cd examples/middleware_showcase
cjpm build
```

#### 2. è¿è¡ŒæœåŠ¡å™¨

```bash
cjpm run
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:10001` å¯åŠ¨ã€‚

#### 3. è®¿é—®ä¸»é¡µ

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š
```
http://localhost:10001/
http://localhost:10001/static/
```

## ğŸ“š API ç«¯ç‚¹

### å…¬å¼€ç«¯ç‚¹

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/` | ä¸»é¡µ |
| GET | `/static/*` | é™æ€æ–‡ä»¶ |
| GET | `/api/info` | API ä¿¡æ¯ï¼ˆJSONï¼‰ |
| GET | `/api/error` | æµ‹è¯•å¼‚å¸¸å¤„ç† |
| GET | `/api/delay` | æ…¢å“åº”æµ‹è¯•ï¼ˆ1ç§’ï¼‰ |

### å—ä¿æŠ¤ç«¯ç‚¹ï¼ˆéœ€è¦è®¤è¯ï¼‰

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/user` | ç”¨æˆ·ä¿¡æ¯ |
| GET | `/api/data` | JSON æ•°æ® |
| GET | `/api/headers` | è¯·æ±‚å¤´ä¿¡æ¯ |

**è®¤è¯ä¿¡æ¯ï¼š**
- ç”¨æˆ·å: `admin`
- å¯†ç : `secret123`

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### ä½¿ç”¨ curl æµ‹è¯•

#### 1. æµ‹è¯•ä¸»é¡µ
```bash
curl http://localhost:10001/
```

#### 2. æµ‹è¯• API ä¿¡æ¯
```bash
curl http://localhost:10001/api/info
```

#### 3. æµ‹è¯•å—ä¿æŠ¤çš„ç«¯ç‚¹ï¼ˆæ— è®¤è¯ï¼‰
```bash
curl http://localhost:10001/api/user
# é¢„æœŸ: 401 Unauthorized
```

#### 4. æµ‹è¯•å—ä¿æŠ¤çš„ç«¯ç‚¹ï¼ˆæœ‰è®¤è¯ï¼‰
```bash
curl -u admin:secret123 http://localhost:10001/api/user
# é¢„æœŸ: 200 OK + JSON å“åº”
```

#### 5. æµ‹è¯•å¼‚å¸¸å¤„ç†
```bash
curl http://localhost:10001/api/error
# é¢„æœŸ: 500 Internal Server Errorï¼ˆä½†æœåŠ¡å™¨ä¸ä¼šå´©æºƒï¼‰
```

#### 6. æµ‹è¯•æ…¢å“åº”
```bash
curl http://localhost:10001/api/delay
# é¢„æœŸ: çº¦ 1 ç§’åè¿”å›å“åº”
```

#### 7. æµ‹è¯• CORS
```bash
curl -H "Origin: http://example.com" \
      -H "Access-Control-Request-Method: GET" \
      -H "Access-Control-Request-Headers: X-Custom-Header" \
      -X OPTIONS \
      http://localhost:10001/api/info
```

#### 8. æµ‹è¯•å‹ç¼©
```bash
curl -H "Accept-Encoding: gzip" \
      http://localhost:10001/api/data \
      --compressed
```

### ä½¿ç”¨æµè§ˆå™¨æµ‹è¯•

1. æ‰“å¼€ `http://localhost:10001/static/` æŸ¥çœ‹ HTML é¡µé¢
2. é¡µé¢åŒ…å«äº¤äº’å¼æµ‹è¯•æŒ‰é’®
3. ç‚¹å‡»æŒ‰é’®æµ‹è¯•ä¸åŒçš„ API ç«¯ç‚¹
4. æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„ï¼š
   - Network æ ‡ç­¾ï¼ˆæŸ¥çœ‹è¯·æ±‚å¤´å’Œå“åº”å¤´ï¼‰
   - Console æ ‡ç­¾ï¼ˆæŸ¥çœ‹å®¢æˆ·ç«¯æ—¥å¿—ï¼‰

## ğŸ“Š è§‚å¯Ÿä¸­é—´ä»¶æ•ˆæœ

### æœåŠ¡å™¨æ§åˆ¶å°æ—¥å¿—

è¿è¡ŒæœåŠ¡å™¨åï¼Œä½ å°†çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼š

```
[INFO] request method=GET path=/api/user status=401 latency=5ms
[INFO] request method=GET path=/api/user status=200 latency=12ms requestid=a1b2c3d4
[INFO] request method=GET path=/api/error status=500 latency=3ms clientip=127.0.0.1
```

è¿™äº›æ—¥å¿—ç”± **Access Log** ä¸­é—´ä»¶ç”Ÿæˆï¼ŒåŒ…å«ï¼š
- `method`: HTTP æ–¹æ³•
- `path`: è¯·æ±‚è·¯å¾„
- `status`: HTTP çŠ¶æ€ç 
- `latency`: è¯·æ±‚å¤„ç†æ—¶é—´
- `requestid`: å”¯ä¸€è¯·æ±‚ IDï¼ˆå¦‚æœæœ‰ï¼‰
- `clientip`: å®¢æˆ·ç«¯ IP åœ°å€ï¼ˆå¦‚æœæœ‰ï¼‰

### å“åº”å¤´

ä½¿ç”¨ `curl -v` æˆ–æµè§ˆå™¨å¼€å‘è€…å·¥å…·å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å“åº”å¤´ï¼š

#### Security Headersï¼ˆç”± Security ä¸­é—´ä»¶æ·»åŠ ï¼‰
```
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Content-Security-Policy: default-src 'self'; script-src 'self'; object-src 'none'; base-uri 'self'
Referrer-Policy: no-referrer
Permissions-Policy: geolocation=(), camera=(), microphone=()
```

#### CORS Headersï¼ˆç”± CORS ä¸­é—´ä»¶æ·»åŠ ï¼‰
```
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
```

#### Compression Headersï¼ˆç”± Compress ä¸­é—´ä»¶æ·»åŠ ï¼‰
```
Content-Encoding: gzip
Vary: Accept-Encoding
```

#### Request ID Headerï¼ˆå¦‚æœå®¢æˆ·ç«¯å‘é€äº† X-Request-IDï¼‰
```
X-Request-ID: abc123def456
```

## ğŸ” ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº

ä¸­é—´ä»¶æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼ˆä»å¤–åˆ°å†…ï¼‰ï¼š

```
Request â†’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Recovery      (æ•è·æ‰€æœ‰å¼‚å¸¸)         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚ 2. Access Log  (å¼€å§‹è®¡æ—¶)       â”‚ â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚    â”‚    â”‚ 3. Request ID           â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚ 4. CORS          â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚ 5. Securityâ”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”â”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚ 6. Compressâ”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”¤â”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚ 7. Log     â”‚â”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚ 8. Basic Authâ”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    (éƒ¨åˆ†è·¯ç”±)â”‚  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚ â”‚
â”‚    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†’ Response
```

**é‡è¦æç¤ºï¼š**
- Recovery å¿…é¡»æ”¾åœ¨æœ€å¤–å±‚ï¼Œä»¥æ•è·æ‰€æœ‰ä¸­é—´ä»¶å’Œ handler çš„å¼‚å¸¸
- Access Log åœ¨è¯·æ±‚å¼€å§‹æ—¶è®¡æ—¶ï¼Œåœ¨å“åº”è¿”å›æ—¶è®°å½•
- Request ID åº”è¯¥å°½æ—©æ‰§è¡Œï¼Œä»¥ä¾¿åç»­ä¸­é—´ä»¶ä½¿ç”¨
- åŸºæœ¬è®¤è¯ç­‰ç‰¹å®šä¸­é—´ä»¶åªåº”ç”¨åˆ°éœ€è¦çš„è·¯ç”±

## ğŸ› ï¸ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹ CORS é…ç½®

åœ¨ `src/main.cj` ä¸­ä¿®æ”¹ CORS é…ç½®ï¼š

```cj
cors([
    withAllowedOrigins(["http://localhost:3000"]),  // åªå…è®¸ç‰¹å®šæ¥æº
    withAllowCommonMethods(),                        // å…è®¸å¸¸ç”¨æ–¹æ³•
    withAllowedHeaders(["Content-Type", "Authorization"]),  // å…è®¸ç‰¹å®šå¤´
    withMaxAge(3600)                                  // é¢„æ£€è¯·æ±‚ç¼“å­˜ 1 å°æ—¶
])
```

### ä¿®æ”¹å®‰å…¨ç­–ç•¥

```cj
security([
    withLooseSecurity()  // å¼€å‘ç¯å¢ƒä½¿ç”¨å®½æ¾ç­–ç•¥
])
```

### å¯ç”¨è¯¦ç»†æ—¥å¿—

```cj
accesslog([
    withUserAgent(),   // è®°å½• User-Agent
    withClientIP()     // è®°å½•å®¢æˆ·ç«¯ IP
])
```

## ğŸ“– æ›´å¤šèµ„æº

- [Tang ä¸»æ–‡æ¡£](../../README.md)
- [ä¸­é—´ä»¶å¼€å‘æŒ‡å—](../../src/middleware/README.md)
- [è·¯ç”±ä½¿ç”¨ç¤ºä¾‹](../basic/)

## ğŸ’¡ æç¤º

1. **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ `withLooseSecurity()` å®‰å…¨ç­–ç•¥ï¼Œé¿å… CSP é™åˆ¶
2. **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ `withStrictSecurity()` å¹¶é…ç½®å…·ä½“çš„ CORS æ¥æº
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šCompression ä¸­é—´ä»¶ä¼šæ¶ˆè€— CPUï¼Œåªåœ¨éœ€è¦æ—¶å¯ç”¨
4. **æ—¥å¿—è®°å½•**ï¼šAccess Log ä¼šè®°å½•æ¯ä¸ªè¯·æ±‚ï¼Œç”Ÿäº§ç¯å¢ƒæ³¨æ„æ—¥å¿—é‡

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ï¼šç«¯å£è¢«å ç”¨
**è§£å†³**ï¼šä¿®æ”¹ `src/main.cj` ä¸­çš„ç«¯å£å·ï¼š
```cj
.port(10002)  // æ”¹ä¸ºå…¶ä»–ç«¯å£
```

### é—®é¢˜ï¼šé™æ€æ–‡ä»¶ 404
**è§£å†³**ï¼šç¡®ä¿ `public/` ç›®å½•å­˜åœ¨ä¸”åŒ…å«æ–‡ä»¶ï¼Œè·¯å¾„ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼š
```cj
staticFiles("public")  // æˆ–ç»å¯¹è·¯å¾„
```

### é—®é¢˜ï¼šè®¤è¯å¤±è´¥
**è§£å†³**ï¼šæ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®ï¼Œé»˜è®¤ä¸º `admin:secret123`

## ğŸ“ è®¸å¯è¯

æœ¬ç¤ºä¾‹é¡¹ç›®éµå¾ªä¸ Tang ä¸»é¡¹ç›®ç›¸åŒçš„è®¸å¯è¯ã€‚
