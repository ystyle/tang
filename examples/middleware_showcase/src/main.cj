package middleware_showcase

import std.collection.HashMap
import std.collection.ArrayList
import std.time.DateTime
import stdx.log.LogLevel
import stdx.net.http.ServerBuilder
import tang.*

// å¯¼å…¥æ‰€æœ‰ä¸­é—´ä»¶
import tang.middleware.exception.recovery
import tang.middleware.accesslog.accesslog
import tang.middleware.requestid.requestid
import tang.middleware.cors.{newCors, withAllowAllOrigins, withAllowCredentials}
import tang.middleware.security.{security, withStrictSecurity}
import tang.middleware.staticfile.{staticFiles, withPrefix}
import tang.middleware.bodylimit.{bodyLimit, withMaxSize}
import tang.middleware.ratelimit.{rateLimit, withMaxRequests}

import tang.middleware.healthcheck.{healthcheck, withLivenessCheck, withReadinessCheck, withSystemInfo}
import tang.middleware.redirect.{redirect, redirectMiddleware}
import tang.middleware.favicon.favicon
import tang.middleware.timeout.{timeout, withTimeout, isTimeout}
import tang.middleware.keyauth.{keyAuth, withKey, withLookup}
import tang.middleware.rewrite.{createRewriteFunction}
import tang.middleware.cache.{cache, withDuration,withRules, withExcludePath, CacheRule}
import tang.middleware.etag.{etag, withWeak}

main() {
    // åˆ›å»ºè·¯ç”±å™¨ï¼Œåº”ç”¨å…¨å±€ä¸­é—´ä»¶
    //
    // ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºå¾ˆé‡è¦ï¼š
    // 1. recovery åº”è¯¥æ”¾åœ¨æœ€å¤–å±‚ï¼Œæ•è·æ‰€æœ‰å¼‚å¸¸
    // 2. accesslog è®°å½•è¯·æ±‚æ—¥å¿—
    // 3. requestid ç”Ÿæˆ/ä¼ é€’è¯·æ±‚ ID
    // 4. ratelimit é™åˆ¶è¯·æ±‚é€Ÿç‡ï¼ˆé˜²æ­¢ DDoSï¼‰
    // 5. bodylimit é™åˆ¶è¯·æ±‚ä½“å¤§å°ï¼ˆé˜²æ­¢å¤§æ–‡ä»¶æ”»å‡»ï¼‰
    // 6. cors å¤„ç†è·¨åŸŸè¯·æ±‚
    // 7. security æ·»åŠ å®‰å…¨å“åº”å¤´
    // 8. cache ç¼“å­˜æ§åˆ¶
    // 9. etag ç¼“å­˜éªŒè¯
    // æ³¨æ„ï¼šKeyAuth ä¸åœ¨å…¨å±€åº”ç”¨ï¼Œåœ¨ç‰¹å®šè·¯ç”±ä¸Šæµ‹è¯•
    let r = Router(
        use([
            favicon(),                            // 0. Favicon å¤„ç†ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
            recovery(),                           // 1. å¼‚å¸¸æ¢å¤ï¼ˆå¿…é¡»æ”¾åœ¨æœ€å¤–å±‚ï¼‰
            accesslog(),                          // 2. è®¿é—®æ—¥å¿—
            requestid(),
            rateLimit([                           // 4. é™æµï¼ˆæ¯åˆ†é’Ÿ 100 ä¸ªè¯·æ±‚ï¼‰
                withMaxRequests(100)
            ]),
            bodyLimit([                           // 5. è¯·æ±‚ä½“é™åˆ¶ï¼ˆæœ€å¤§ 10MBï¼‰
                withMaxSize(10 * 1024 * 1024)
            ]),
            newCors([                             // 6. CORS è·¨åŸŸæ”¯æŒ
                withAllowAllOrigins(),            //    å…è®¸æ‰€æœ‰æ¥æº
                withAllowCredentials()            //    å…è®¸æºå¸¦å‡­è¯
            ]),
            security([withStrictSecurity()]),     // 7. å®‰å…¨å¤´ï¼ˆä¸¥æ ¼ç­–ç•¥ï¼‰
            cache([                               // 8. Cache ç¼“å­˜æ§åˆ¶
                withDuration(3600),               //     é»˜è®¤ç¼“å­˜ 1 å°æ—¶
                withExcludePath("/test/nocache"), //     æ’é™¤æ‰‹åŠ¨è®¾ç½® header çš„è·¯å¾„
                withRules([
                    CacheRule("/api/*", 0),       // API ä¸ç¼“å­˜
                    CacheRule("/static/*", 86400) // é™æ€æ–‡ä»¶ç¼“å­˜ 1 å¤©
                ])
            ]),
            etag(),                               // 9. ETag ç¼“å­˜éªŒè¯
            timeout(withTimeout(2000))
        ])
    )

    // æ·»åŠ è·¯å¾„é‡å†™è§„åˆ™ï¼ˆåœ¨è·¯ç”±åŒ¹é…ä¹‹å‰æ‰§è¡Œï¼‰
    r.addRewriteRule(createRewriteFunction("/api/v1/(.*)", "/api/v2/$1"))
    r.addRewriteRule(createRewriteFunction("/old/api/(.*)", "/api/$1"))

    // ============ æµ‹è¯•è·¯ç”± ============

    // åŸºç¡€è·¯ç”±ï¼šè¿”å›è¯·æ±‚ ID
    r.get("/", { ctx =>
        let rid = ctx.requestid()
        let ridStr = match (rid) {
            case Some(v) => v
            case None => "none"
        }
        let body = #"Welcome to Tang Middleware Showcase!
            Request ID: ${ridStr}
            Available endpoints:
            - GET  /                      - Homepage
            - GET  /health                - Basic health check
            - GET  /health/full           - Full health check with system info
            - GET  /old-path              - Test redirect (301 -> /new-path)
            - GET  /new-path              - Redirect target
            - GET  /api/info              - API info
            - GET  /api/user              - Protected with KeyAuth (X-API-Key header)
            - GET  /api/data              - JSON response
            - GET  /api/error             - Test exception recovery
            - GET  /api/headers           - Show all request headers
            - GET  /api/delay             - Test slow response (1s)
            - GET  /api/slow              - Test timeout middleware
            - POST /api/upload            - Test body limit (max 10MB)
            - GET  /api/test-limit        - Test rate limit (100 req/min)
            - GET  /api/test-cache        - Test Cache & ETag middleware
            - GET  /old/api/info          - Test Rewrite middleware -> /api/info
            - GET  /static/*              - Static files (real files from public/)
            "#
        ctx.responseBuilder.body(body)
        println("Request ID: ${ridStr}")  // ä½¿ç”¨ ridStr é¿å…è­¦å‘Š
    })


    // ============ æ–°ä¸­é—´ä»¶æµ‹è¯•è·¯ç”±ï¼ˆå¾…è§£å†³æ¨¡å—å¯¼å‡ºé—®é¢˜ï¼‰===========
    // å¥åº·æ£€æŸ¥
    r.get("/health", healthcheck())

    // å¸¦è‡ªå®šä¹‰æ£€æŸ¥çš„å¥åº·æ£€æŸ¥
    r.get("/health/full", healthcheck([
        withLivenessCheck({ ctx => true }),
        withReadinessCheck({ ctx => true }),
        withSystemInfo()
    ]))

    // é‡å®šå‘æµ‹è¯•
    r.get("/old-path", redirect(url: "/new-path", statusCode: 301))
    r.get("/new-path", { ctx => ctx.responseBuilder.body("This is the new path!\n") })

    // è¶…æ—¶æµ‹è¯•
    r.get("/api/slow", { ctx =>
        // æ¨¡æ‹Ÿæ…¢æ“ä½œ
        sleep(Duration.second * 1)

        // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
        if (isTimeout(ctx)) {
            ctx.responseBuilder.status(504).body("Request timeout\n")
            return
        }

        ctx.responseBuilder.body("Slow operation completed\n")
    })

    // ============ æ–°ä¸­é—´ä»¶æµ‹è¯•è·¯ç”± ============

    // ========== KeyAuth æµ‹è¯• ==========
    // å…¬å¼€ç«¯ç‚¹ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
    r.get("/test/keyauth", { ctx =>
        ctx.json(HashMap<String, String>([
            ("message", "This is a public endpoint"),
            ("auth", "not required"),
            ("test", "Try accessing /test/keyauth/protected with X-API-Key header")
        ]))
    })

    // å—ä¿æŠ¤ç«¯ç‚¹ï¼ˆéœ€è¦ KeyAuthï¼‰
    let protectedRoutes = r.group("/test/keyauth")
    protectedRoutes.use(
        keyAuth([
            withKey("test-secret-key-12345"),
            withLookup("header:X-API-Key")
        ])
    )

    protectedRoutes.get("/protected", { ctx =>
        ctx.json(HashMap<String, String>([
            ("message", "You are authenticated!"),
            ("auth", "success"),
            ("info", "KeyAuth middleware is working correctly")
        ]))
    })

    // ========== Rewrite æµ‹è¯• ==========
    // Rewrite ä¸­é—´ä»¶å·²åœ¨å…¨å±€ä¸­é—´ä»¶ä¸­é…ç½®ï¼ˆç¬¬ 61-62 è¡Œï¼‰
    // è¿™é‡Œåªéœ€è¦æ³¨å†Œç›®æ ‡è·¯ç”±å³å¯

    // ========== Cache æµ‹è¯• ==========
    r.get("/test/cache", { ctx =>
        ctx.json(HashMap<String, String>([
            ("message", "This response is cached for 1 hour"),
            ("cache-control", "max-age=3600"),
            ("hint", "Check the Cache-Control response header")
        ]))
    })

    r.get("/test/nocache", { ctx =>
        // æ‰‹åŠ¨è®¾ç½® Cache-Control headerï¼ˆä¸­é—´ä»¶å·²æ’é™¤æ­¤è·¯å¾„ï¼‰
        ctx.responseBuilder.header("Cache-Control", "no-store, no-cache, must-revalidate")
        ctx.json(HashMap<String, String>([
            ("message", "This response is not cached"),
            ("cache-control", "no-store")
        ]))
    })

    // ========== ETag æµ‹è¯• ==========
    r.get("/test/etag", { ctx =>
        ctx.json(HashMap<String, String>([
            ("message", "This response includes ETag header"),
            ("timestamp", "${DateTime.now()}"),
            ("etag", "Check the ETag response header"),
            ("hint", "ETag is generated from URL path and query params")
        ]))
    })

    // Favicon æµ‹è¯• - ç›´æ¥è·¯ç”±å¤„ç†å™¨
    r.get("/favicon.ico", { ctx =>
        // 1x1 é€æ˜ GIF
        let gifData = Array<UInt8>(35, { i =>
            [0x47u8, 0x49u8, 0x46u8, 0x38u8, 0x39u8, 0x61u8, 0x01u8, 0x00u8,
             0x01u8, 0x00u8, 0x00u8, 0x00u8, 0x00u8, 0x21u8, 0xF9u8, 0x04u8,
             0x01u8, 0x00u8, 0x00u8, 0x00u8, 0x00u8, 0x2Cu8, 0x00u8, 0x00u8,
             0x00u8, 0x00u8, 0x01u8, 0x00u8, 0x01u8, 0x00u8, 0x00u8, 0x02u8,
             0x02u8, 0x04u8, 0x01u8, 0x00u8, 0x3Bu8][i]
        })
        ctx.responseBuilder.status(200u16)
        ctx.responseBuilder.header("Content-Type", "image/x-icon")
        ctx.responseBuilder.header("Cache-Control", "public, max-age=86400")
        ctx.responseBuilder.body(gifData)
    })

    // ============ åŸæœ‰ API è·¯ç”± ============

    // API ä¿¡æ¯è·¯ç”±
    r.get("/api/info", { ctx =>
        let rid = ctx.requestid()
        let ridStr = rid ?? "unknown"
        let clientIP = ctx.request.headers.getFirst("X-Real-IP") ?? ctx.request.headers.getFirst("X-Forwarded-For") ?? ctx.request.remoteAddr

        ctx.json(HashMap<String, String>([
            ("framework", "Tang"),
            ("language", "Cangjie"),
            ("version", "0.1.0"),
            ("requestId", ridStr),
            ("clientIP", clientIP)
        ]))
    })

    // åˆ›å»º API åˆ†ç»„
    let api = r.group("/api")

    // Rewrite æµ‹è¯•è·¯ç”±ï¼š/api/v1/users -> /api/v2/users
    api.get("/v2/users", { ctx =>
        ctx.json(HashMap<String, String>([
            ("users", "[]"),
            ("note", "This endpoint can be accessed via /api/v1/users (rewritten to /api/v2/users)")
        ]))
    })

    // Rewrite æµ‹è¯•è·¯ç”±ï¼š/old/api/data -> /api/data
    api.get("/data", { ctx =>
        ctx.json(HashMap<String, String>([
            ("message", "URL was rewritten from /old/api/data to /api/data"),
            ("original", "/old/api/data"),
            ("current", "/api/data"),
            ("middleware", "Rewrite is working!")
        ]))
    })

    api.get("/test-cache", { ctx =>
        // æµ‹è¯• Cache å’Œ ETag ä¸­é—´ä»¶
        let data = HashMap<String, String>([
            ("timestamp", "${DateTime.now()}"),
            ("message", "This response should have Cache-Control and ETag headers"),
            ("cache", "Check the Cache-Control header"),
            ("etag", "Check the ETag header")
        ])
        ctx.json(data)
    })

    // æµ‹è¯•å¼‚å¸¸æ¢å¤
    api.get("/error", { _ =>
        throw Exception("This is a test exception to demonstrate recovery middleware")
    })

    // æ˜¾ç¤ºæ‰€æœ‰è¯·æ±‚å¤´
    api.get("/headers", { ctx =>
        var headersInfo = ArrayList<String>()
        for ((name, values) in ctx.request.headers) {
            for (value in values) {
                headersInfo.add("${name}: ${value}")
            }
        }
        ctx.responseBuilder.body(String.join(headersInfo.toArray(), delimiter: "\n"))
    })

    // æµ‹è¯•æ…¢å“åº”ï¼ˆç”¨äºæµ‹è¯• accesslog çš„å»¶è¿Ÿè®°å½•ï¼‰
    api.get("/delay", { ctx =>
        // æ¨¡æ‹Ÿä¸€äº›å¤„ç†æ—¶é—´
        sleep(Duration.second) // ç¡çœ  1 ç§’
        ctx.responseBuilder.body("This request took about 1 second to process\n")
    })

    // æµ‹è¯•è¯·æ±‚ä½“é™åˆ¶
    api.post("/upload", { ctx =>
        ctx.responseBuilder.body("Upload endpoint (max 10MB)\n")
    })

    // æµ‹è¯•é™æµ
    api.get("/test-limit", { ctx =>
        ctx.responseBuilder.body("If you see this, rate limit is working (100 req/min)\n")
    })

    // é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆä» public ç›®å½•æä¾›æ–‡ä»¶ï¼‰
    // ä½¿ç”¨ç»å¯¹è·¯å¾„é¿å…å·¥ä½œç›®å½•é—®é¢˜
    r.get("/static/*", staticFiles("/home/ystyle/Code/CangJie/online/tang/examples/middleware_showcase/public", [withPrefix("/static")]))
    r.get("/static", staticFiles("/home/ystyle/Code/CangJie/online/tang/examples/middleware_showcase/public", [withPrefix("/static")]))

    // ä¸ºæ‰€æœ‰è·¯å¾„æ·»åŠ  OPTIONS å¤„ç†å™¨ï¼Œè®© CORS ä¸­é—´ä»¶èƒ½å¤Ÿå¤„ç†é¢„æ£€è¯·æ±‚
    // æ³¨æ„ï¼šéœ€è¦ä¸ºæ¯ä¸ªè·¯å¾„å‰ç¼€æ³¨å†Œ OPTIONS è·¯ç”±ï¼Œå› ä¸º radix tree çš„ /* åªåŒ¹é…å•å±‚è·¯å¾„
    r.options("/*", { ctx =>
        ctx.responseBuilder.body("")
    })
    api.options("/*", { ctx =>
        ctx.responseBuilder.body("")
    })

    // ============ å¯åŠ¨æœåŠ¡å™¨ ============

    let server = ServerBuilder()
        .distributor(r)
        .addr("127.0.0.1")
        .port(10001)
        .build()

    // è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º INFOï¼Œä»¥ä¾¿çœ‹åˆ°ä¸­é—´ä»¶æ—¥å¿—
    server.logger.level = LogLevel.INFO

    println("========================================")
    println("  Tang Middleware Showcase Server")
    println("========================================")
    println("")
    println("Server running at: http://localhost:${server.port}")
    println("")
    println("ğŸ” Middleware Testing Guide:")
    println("")
    println("[KeyAuth Test]")
    println("  curl http://localhost:${server.port}/test/keyauth")
    println("  curl -H 'X-API-Key: test-secret-key-12345' http://localhost:${server.port}/test/keyauth/protected")
    println("")
    println("[Rewrite Test]")
    println("  curl http://localhost:${server.port}/old/api/data")
    println("  curl http://localhost:${server.port}/api/v1/users")
    println("")
    println("[Cache Test]")
    println("  curl -I http://localhost:${server.port}/test/cache")
    println("  curl -I http://localhost:${server.port}/test/nocache")
    println("")
    println("[ETag Test]")
    println("  curl -I http://localhost:${server.port}/test/etag")
    println("")
    println("Press Ctrl+C to stop the server")
    println("========================================")
    println("")

    server.serve()
}
